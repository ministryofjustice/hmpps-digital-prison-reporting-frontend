{% extends layoutTemplate %}

{% from "moj/components/button-menu/macro.njk" import mojButtonMenu -%}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "../data-table/view.njk" import dprDataTable %}
{% from "../dropdown-button/view.njk"    import dprDropdownButton %}
{% from "../accordion/view.njk" import dprAccordion %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% from "../filters/view.njk" import dprFilters %}
{% from "../columns/view.njk" import dprColumns %}

{% set pageTitle = applicationName + " - " + title %}
{% set mainClasses = "app-container govuk-body" %}
{% set urlWithNoFilters = dataTableOptions.currentQueryParams | createUrlForParameters(null) %}

{% set actions = [] %}
{% if (dataTableOptions.printable) %}
  {% set printAttributes = {
    'id': 'print-button',
    'onclick': 'window.print()'
  } %}
{% else %}
  {% set printAttributes = {
    'id': 'print-button-disabled',
    'disabled': 'true'
  } %}
{% endif %}

{% set printAction = {
  text: 'Print displayed results',
  attributes: printAttributes,
  classes: 'filter-summary-controls'
} %}
{% set actions = (actions.push(printAction), actions) %}

{% set subject = title | urlencode %}
{% set body = (dataTableOptions.url) | urlencode %}
{% set shareOptions = {
  title: "Share:",
  items: [
    {
      text: 'Copy URL',
      attributes: {
        'id': 'copy-url-button',
        'onclick': 'navigator.clipboard.writeText(window.location)'
      },
      classes: 'filter-summary-controls'
    },
    {
      text: 'Email',
      href: 'mailto:?subject=' + subject + '&body=' + body,
      attributes: {
        'id': 'email-button'
      },
      classes: 'filter-summary-controls'
    }
  ]
} %}

{% set selectedFilters = filterOptions.selectedFilters %}
{% set filterHtml %}
<div class="data-table-filters">
  {{ dprFilters(
    filterOptions.filters,
    urlWithNoFilters
  ) }}
</div>
{% endset %}

{% set colsData = {
    name: "columns",
    options: columnOptions.columns,
    value: columnOptions.selectedColumns
}%}

{% set columnsHtml %}
<div class="data-table-columns">
  {{ dprColumns(colsData) }}
</div>
{% endset %}

{% set filtersHeaderHtml %}
{%- for selectedFilter in selectedFilters %}
  <div class="selected-accordion-button">
    {{ govukButton(selectedFilter) }}
  </div>
{%- endfor %}
{% endset %}

{% set colsHeaderHtml %}
<div class="columns-header">
  <p class="govuk-body govuk-!-margin-bottom-0">{{ colsData.value.length }} of {{ colsData.options.length }} shown</p>
</div>
{% endset %}

{% set accordionItems = [
  {
    summaryText: 'Filters',
    bodyHtml: filterHtml,
    headerHtml: filtersHeaderHtml
  }, {
    summaryText: 'Columns',
    bodyHtml: columnsHtml,
    headerHtml: colsHeaderHtml
  }
] %}

{% block content %}
  <div class="govuk-width-container {% if (dataTableOptions.printable == false) %}print-hide{% endif %}">
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-two-thirds">
        <h1 class="govuk-heading-m">{{ title }}</h1>
      </div>
      <div class="govuk-grid-column-one-third">
        <div class="dpr-actions">
          {{ dprDropdownButton({
            id: "actions",
            text: "Actions",
            classes: "",
            attributes: {},
            items: actions,
            groups: [ shareOptions ]
          }) }}
        </div>
      </div>
    </div>

    {% if warnings.noDataAvailable %}
      {{ govukErrorSummary({
      titleText: 'No data available',
      errorList: [
        {
          text: warnings.noDataAvailable
        }
      ]
    }) }}
    {% endif %}

    <div class="moj-filter-layout">
      <div class="moj-filter-layout__content">
        <div class="moj-action-bar">
          {{ dprAccordion(accordionItems) }}
        </div>
        <div class="moj-scrollable-pane">
          {{ dprDataTable(
          dataTableOptions.head,
          dataTableOptions.rows,
          dataTableOptions.count,
          dataTableOptions.currentQueryParams,
          dataTableOptions.classification
        ) }}
        </div>
      </div>
    </div>
  </div>

  {% if (dataTableOptions.printable == false) %}
    <h3 class="screen-hide">
      Printing this report has been disabled due to time or content sensitivity.<br/>
      Please speak to your report administrator for further details.
    </h3>
  {% endif %}

{% endblock %}